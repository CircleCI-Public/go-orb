description: |
  Install Go in a build. Supports Linux/amd64 and macOS/amd64.
parameters:
  version:
    description: "The Go version."
    type: string
    default: "1.14.4"
  cache:
    description: Whether or not to cache the binary.
    type: boolean
    default: true
  cache-key:
    description: |
      String to use in cache key. Typically overriden when needed to bust cache.
    type: string
    default: "v1"
steps:
  - os-detect/init
  - when:
      condition:
        equal: [ <<parameters.cache>>, true ]
      steps:
        - run:
            name: "Prep cache restore"
            command: |
              $SUDO install -o $(whoami) -d /usr/local/go
        - restore_cache:
            keys:
              - go-binary-<<parameters.cache-key>>-<<parameters.version>>-{{ arch }}
  - run:
      name: "Install Go"
      command: |
        : ${OSD_FAMILY:="linux"}
        if command -v uname >/dev/null; then
          : ${HOSTTYPE:="$(uname -m)"}
        else
          : ${HOSTTYPE:="amd64"}
        fi
        case "${HOSTTYPE}" in
          aarch64)    HOSTTYPE="arm64" ;;
          arm|armv*l) HOSTTYPE="armv6l" ;;
          x86_64) HOSTTYPE="amd64" ;;
          *86)    HOSTTYPE="386" ;;
        esac
        : ${USER:="$(whoami)"}

        if command -v go >/dev/null; then
          if go version | grep -q -F "go<< parameters.version >> "; then
            echo "Binary already exists, skipping download."
            exit 0
          fi

          echo "Found a different version of Go."
          if go version >/dev/null; then
            OSD_FAMILY="$(go env GOHOSTOS)"
            HOSTTYPE="$(go env GOHOSTARCH)"
          fi
        fi
        if [ -d /usr/local/go ]; then
          $SUDO mv /usr/local/go /usr/local/go~
          $SUDO rm -rf /usr/local/go~ &
        fi

        echo "Installing the requested version of Go."

        $SUDO install -o ${USER} -d /usr/local/go
        curl --fail --location -sS "https://dl.google.com/go/go<< parameters.version >>.${OSD_FAMILY}-${HOSTTYPE}.tar.gz" \
        | sudo tar --no-same-owner --strip-components=1 --gunzip -x -C /usr/local/go/

        if ! grep -q --max-count=1 "PATH=.*/usr/local/go/bin" "${BASH_ENV}"; then
          echo "export PATH=\"/usr/local/go/bin:${PATH}\"" >>"${BASH_ENV}"
        fi
        $SUDO chown -R ${USER}: /usr/local/go
        wait
  - run:
      name: "Verify Go Installation"
      command: echo "Installed " && go version
  - when:
      condition:
        equal: [ <<parameters.cache>>, true ]
      steps:
        - save_cache:
            key: go-binary-<<parameters.cache-key>>-<<parameters.version>>-{{ arch }}
            paths:
              - /usr/local/go
